---
description: WP APIを利用する際
alwaysApply: false
---
# WordPress API 使用時の注意事項

## カテゴリ・タグを使った記事取得のベストプラクティス

### ❌ やってはいけないこと

1. **クライアント側でのフィルタリング**
   - 大量の記事を取得してクライアント側でフィルタリングするのは非効率
   - パフォーマンスが最悪で、不要なデータ転送が発生する
   - ページネーションが正しく動作しない

2. **whileループを使った複数ページの取得**
   - パフォーマンスが最悪
   - ページネーションで不具合が起きる
   - 不要なAPIリクエストが発生する

3. **言語フィルタリングをクライアント側で行う**
   - WordPress APIが言語フィルタリングをサポートしていない場合でも、クライアント側でフィルタリングするのは非効率
   - 記事が存在しない言語の場合は早期リターンで対応する

### ✅ 正しい実装方法

#### 1. カテゴリでフィルタリングする場合

```typescript
// 1. カテゴリslugからIDを取得
const categoryResponse = await fetch(
  `https://wp-api.wp-kyoto.net/wp-json/wp/v2/categories?slug=${encodeURIComponent(categorySlug)}`
)
const categories = await categoryResponse.json()
const categoryId = categories[0].id

// 2. WordPress APIのcategoriesパラメータでフィルタリング
const response = await fetch(
  `https://wp-api.wp-kyoto.net/wp-json/wp/v2/posts?categories=${categoryId}&page=${page}&per_page=${perPage}`
)

// 3. レスポンスヘッダーから総件数と総ページ数を取得
const totalItems = parseInt(response.headers.get('X-WP-Total') || '0', 10)
const totalPages = parseInt(response.headers.get('X-WP-TotalPages') || '0', 10)
```

**ポイント:**
- カテゴリslugからIDを取得してから、`categories`パラメータでフィルタリング
- WordPress API側でフィルタリングするため、必要なデータのみ取得できる
- ページネーションも正しく動作する

#### 2. タグでフィルタリングする場合

```typescript
// 1. タグslugからIDを取得
const tagResponse = await fetch(
  `https://wp-api.wp-kyoto.net/wp-json/wp/v2/tags?slug=${encodeURIComponent(tagSlug)}`
)
const tags = await tagResponse.json()
const tagId = tags[0].id

// 2. WordPress APIのtagsパラメータでフィルタリング
const response = await fetch(
  `https://wp-api.wp-kyoto.net/wp-json/wp/v2/posts?tags=${tagId}&page=${page}&per_page=${perPage}`
)
```

**ポイント:**
- タグslugからIDを取得してから、`tags`パラメータでフィルタリング
- カテゴリと同様に、API側でフィルタリングする

#### 3. ページネーションの実装

```typescript
// WordPress APIのレスポンスヘッダーから総件数と総ページ数を取得
const totalItems = parseInt(response.headers.get('X-WP-Total') || '0', 10)
const totalPages = parseInt(response.headers.get('X-WP-TotalPages') || '0', 10)

// クライアント側でのスライス処理は不要
// API側で既にページネーションされたデータが返ってくる
```

**ポイント:**
- `X-WP-Total`と`X-WP-TotalPages`ヘッダーから正確な総件数と総ページ数を取得
- クライアント側でのスライス処理は不要

#### 4. 記事が存在しない言語の処理

```typescript
// 記事が存在しない言語の場合は早期リターン
if (lang === 'en') {
  return {
    items: [],
    totalPages: 0,
    totalItems: 0,
    currentPage: page,
  }
}
```

**ポイント:**
- 記事が存在しない言語の場合は、APIリクエストを送る前に早期リターン
- 不要なAPIリクエストを避ける

### 参考: WordPress REST API のパラメータ

- `categories`: カテゴリIDでフィルタリング（カンマ区切りで複数指定可能）
- `tags`: タグIDでフィルタリング（カンマ区切りで複数指定可能）
- `page`: ページ番号（1から始まる）
- `per_page`: 1ページあたりの件数
- `X-WP-Total`: レスポンスヘッダーに含まれる総件数
- `X-WP-TotalPages`: レスポンスヘッダーに含まれる総ページ数

### 過去の問題例

**問題のある実装:**
- `while`ループで複数ページを取得してクライアント側でフィルタリング
- 言語フィルタリングのために大量のデータを取得
- クライアント側でスライス処理を行ってページネーションを実装

**結果:**
- パフォーマンスが最悪
- ページネーションが正しく動作しない
- 不要なデータ転送が発生

**解決策:**
- WordPress APIの`categories`/`tags`パラメータを使用
- レスポンスヘッダーから総件数と総ページ数を取得
- 記事が存在しない言語の場合は早期リターン

