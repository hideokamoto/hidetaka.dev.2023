version: 2.1

orbs:
  node: circleci/node@7.2.0

executors:
  default:
    docker:
      - image: cimg/node:22.1
    resource_class: small

jobs:
  lint:
    executor: default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run Biome lint check
          command: npm run lint:check
          no_output_timeout: 5m

  test:
    executor: default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Run tests with coverage
          command: npm run test:coverage
          no_output_timeout: 10m
      - store_artifacts:
          path: coverage
          destination: coverage

  cf-build:
    executor: default
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
      - run:
          name: Build for Cloudflare Workers
          command: npm run cf:build
          no_output_timeout: 10m
          environment:
            MICROCMS_API_MODE: mock
      - persist_to_workspace:
          root: .
          paths:
            - .open-next
      - store_artifacts:
          path: .open-next
          destination: build-output

  # deploy-production:
  #   executor: default
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - node/install-packages:
  #         pkg-manager: npm
  #     - run:
  #         name: Deploy to production
  #         command: npx wrangler versions deploy --yes --message "Deployed by CircleCI from commit ${CIRCLE_SHA1}"

  # deploy-branch:
  #   executor: default
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: .
  #     - node/install-packages:
  #         pkg-manager: npm
  #     - run:
  #         name: Upload version for testing (Durable Objects compatible)
  #         command: |
  #           # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã›ãšï¼‰
  #           npx wrangler versions upload --message "Branch ${CIRCLE_BRANCH} - Commit ${CIRCLE_SHA1}"
  #
  #           # ãƒãƒ¼ã‚¸ãƒ§ãƒ³IDã‚’å–å¾—
  #           VERSION_ID=$(npx wrangler versions list --json | jq -r '.[0].id')
  #
  #           echo "=========================================="
  #           echo "âœ… Version uploaded: ${VERSION_ID}"
  #           echo ""
  #           echo "âš ï¸  Durable Objectsä½¿ç”¨ã®ãŸã‚ã€ç‹¬ç«‹ã—ãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã¯ç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã€‚"
  #           echo ""
  #           echo "ğŸ“‹ Version Overrideãƒ˜ãƒƒãƒ€ãƒ¼ã§ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ï¼š"
  #           echo ""
  #           echo "ã€curlã§ã®ãƒ†ã‚¹ãƒˆã€‘"
  #           echo "curl https://hidetaka-dev-workers.workers.dev \\"
  #           echo "  -H 'Cloudflare-Workers-Version-Overrides: hidetaka-dev-workers=\"${VERSION_ID}\"'"
  #           echo ""
  #           echo "ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ãƒ†ã‚¹ãƒˆã€‘"
  #           echo "1. ãƒ–ãƒ©ã‚¦ã‚¶æ‹¡å¼µï¼ˆModHeaderç­‰ï¼‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
  #           echo "2. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ ï¼š"
  #           echo "   Name: Cloudflare-Workers-Version-Overrides"
  #           echo "   Value: hidetaka-dev-workers=\"${VERSION_ID}\""
  #           echo "3. https://hidetaka-dev-workers.workers.dev ã«ã‚¢ã‚¯ã‚»ã‚¹"
  #           echo ""
  #           echo "è©³ç´°: docs/guides/circleci-setup.md#durable-objectsä½¿ç”¨æ™‚ã®åˆ¶ç´„"
  #           echo "=========================================="

workflows:
  build-test-deploy:
    jobs:
      - lint
      - test:
          requires:
            - lint
      - cf-build:
          requires:
            - lint
      # - deploy-production:
      #     requires:
      #       - cf-build
      #       - test
      #     filters:
      #       branches:
      #         only: main
      # - deploy-branch:
      #     requires:
      #       - cf-build
      #       - test
      #     filters:
      #       branches:
      #         ignore: main
