name: CI

on:
  push:
    branches: [main, claude/**]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

jobs:
  # 変更されたファイルを検出するジョブ
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      lint: ${{ steps.filter.outputs.lint }}
      test: ${{ steps.filter.outputs.test }}
      build: ${{ steps.filter.outputs.build }}
      cf-build: ${{ steps.filter.outputs.cf-build }}
      workflow: ${{ steps.filter.outputs.workflow }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            lint:
              - 'src/**/*.{ts,tsx,js,jsx,json,css}'
              - 'biome.json'
              - 'package.json'
              - 'package-lock.json'
            test:
              - 'src/**/*'
              - 'vitest.config.ts'
              - 'package.json'
              - 'package-lock.json'
            build:
              - 'src/**/*'
              - 'public/**/*'
              - 'next.config.ts'
              - 'tsconfig.json'
              - 'tailwind.config.cjs'
              - 'package.json'
              - 'package-lock.json'
            cf-build:
              - 'src/**/*'
              - 'public/**/*'
              - 'next.config.ts'
              - 'tsconfig.json'
              - 'tailwind.config.cjs'
              - 'wrangler.jsonc'
              - 'package.json'
              - 'package-lock.json'
            workflow:
              - '.github/workflows/test.yml'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: changes
    if: needs.changes.outputs.lint == 'true' || needs.changes.outputs.workflow == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint:check

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, lint]
    if: needs.changes.outputs.workflow == 'true' || (needs.changes.outputs.test == 'true' && needs.lint.conclusion != 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/

  build:
    name: Next.js Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, lint]
    if: needs.changes.outputs.workflow == 'true' || (needs.changes.outputs.build == 'true' && needs.lint.conclusion != 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build
        env:
          MICROCMS_API_MODE: mock

  cf-build:
    name: OpenNext Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [changes, lint]
    if: needs.changes.outputs.workflow == 'true' || (needs.changes.outputs.cf-build == 'true' && needs.lint.conclusion != 'failure')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Cloudflare
        run: npm run cf:build
        env:
          MICROCMS_API_MODE: mock
